<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Forecasting With Exogenous Regressors &mdash; Merlion 2.0.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Adding a New Forecasting Model" href="4_ForecastNewModel.html" />
    <link rel="prev" title="Multivariate Time Series Forecasting" href="2_ForecastMultivariate.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Merlion
          </a>
              <div class="version">
                latest
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../merlion.html">merlion: Time Series Intelligence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ts_datasets.html">ts_datasets: Easy Data Loading</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../tutorials.html">Tutorials &amp; Example Code</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../tutorials.html#basics">Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials.html#anomaly-detection">Anomaly Detection</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../tutorials.html#forecasting">Forecasting</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="0_ForecastIntro.html">A Gentle Introduction to Forecasting in Merlion</a></li>
<li class="toctree-l3"><a class="reference internal" href="1_ForecastFeatures.html">How to Use Forecasters in Merlion</a></li>
<li class="toctree-l3"><a class="reference internal" href="2_ForecastMultivariate.html">Multivariate Time Series Forecasting</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Forecasting With Exogenous Regressors</a></li>
<li class="toctree-l3"><a class="reference internal" href="4_ForecastNewModel.html">Adding a New Forecasting Model</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials.html#advanced-features">Advanced Features</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture.html">Merlion Architecture</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Merlion</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../tutorials.html">Tutorials &amp; Example Code</a></li>
      <li class="breadcrumb-item active">Forecasting With Exogenous Regressors</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/tutorials/forecast/3_ForecastExogenous.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="Forecasting-With-Exogenous-Regressors">
<h1>Forecasting With Exogenous Regressors<a class="headerlink" href="#Forecasting-With-Exogenous-Regressors" title="Permalink to this heading"></a></h1>
<p>Consider a multivariate time series <span class="math notranslate nohighlight">\(X^{(1)}, \ldots, X^{(t)}\)</span>, where each <span class="math notranslate nohighlight">\(X^{(i)} \in \mathbb{R}^d\)</span> is a d-dimensional vector. In multivariate forecasting, our goal is to predict the future values of the k’th univariate <span class="math notranslate nohighlight">\(X_k^{(t+1)}, \ldots, X_k^{(t+h)}\)</span>.</p>
<p>Exogenous regressors <span class="math notranslate nohighlight">\(Y^{(i)}\)</span> are a set of additional variables whose values we know a priori. The task of forecasting with exogenous regressors is to predict our target univariate <span class="math notranslate nohighlight">\(X_k^{(t+1)}, \ldots, X_k^{(t+h)}\)</span>, conditioned on - The past values of the time series <span class="math notranslate nohighlight">\(X^{(1)}, \ldots, X^{(t)}\)</span> - The past values of the exogenous regressors <span class="math notranslate nohighlight">\(Y^{(1)}, \ldots, Y^{(t)}\)</span> - The <em>future</em> values of the exogenous regressors <span class="math notranslate nohighlight">\(Y^{(t+1)}, \ldots, Y^{(t+h)}\)</span></p>
<p>For example, one can consider the task of predicting the sales of a specific item at a store. Endogenous variables <span class="math notranslate nohighlight">\(X^{(i)} \in \mathbb{R}^4\)</span> may contain the number of units sold (the target univariate), the temperature outside, the consumer price index, and the current unemployemnt rate. Exogenous variables <span class="math notranslate nohighlight">\(Y^{(i)} \in \mathbb{R}^6\)</span> are variables that the store has control over or prior knowledge of. They may include whether a particular day is a holiday, and various information
about the sort of markdowns the store is running.</p>
<p>To be more concrete, let’s show this with some real data.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This is the same dataset used in the custom dataset tutorial</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">ts_datasets.forecast</span> <span class="kn">import</span> <span class="n">CustomDataset</span>
<span class="n">csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;walmart&quot;</span><span class="p">,</span> <span class="s2">&quot;walmart_mini.csv&quot;</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">(</span><span class="n">rootdir</span><span class="o">=</span><span class="n">csv</span><span class="p">,</span> <span class="n">index_cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Store&quot;</span><span class="p">,</span> <span class="s2">&quot;Dept&quot;</span><span class="p">],</span> <span class="n">test_frac</span><span class="o">=</span><span class="mf">0.10</span><span class="p">)</span>
<span class="n">ts</span><span class="p">,</span> <span class="n">md</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">display</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Weekly_Sales</th>
      <th>Temperature</th>
      <th>Fuel_Price</th>
      <th>MarkDown1</th>
      <th>MarkDown2</th>
      <th>MarkDown3</th>
      <th>MarkDown4</th>
      <th>MarkDown5</th>
      <th>CPI</th>
      <th>Unemployment</th>
      <th>IsHoliday</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2010-02-05</th>
      <td>39602.47</td>
      <td>40.19</td>
      <td>2.572</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>210.752605</td>
      <td>8.324</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2010-02-12</th>
      <td>37984.44</td>
      <td>38.49</td>
      <td>2.548</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>210.897994</td>
      <td>8.324</td>
      <td>True</td>
    </tr>
    <tr>
      <th>2010-02-19</th>
      <td>38889.43</td>
      <td>39.69</td>
      <td>2.514</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>210.945160</td>
      <td>8.324</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2010-02-26</th>
      <td>41137.74</td>
      <td>46.10</td>
      <td>2.561</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>210.975957</td>
      <td>8.324</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2010-03-05</th>
      <td>39883.50</td>
      <td>47.17</td>
      <td>2.625</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>211.006754</td>
      <td>8.324</td>
      <td>False</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2012-09-28</th>
      <td>37104.67</td>
      <td>79.45</td>
      <td>3.666</td>
      <td>7106.05</td>
      <td>1.91</td>
      <td>1.65</td>
      <td>1549.10</td>
      <td>3946.03</td>
      <td>222.616433</td>
      <td>6.565</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2012-10-05</th>
      <td>36361.28</td>
      <td>70.27</td>
      <td>3.617</td>
      <td>6037.76</td>
      <td>NaN</td>
      <td>10.04</td>
      <td>3027.37</td>
      <td>3853.40</td>
      <td>222.815930</td>
      <td>6.170</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2012-10-12</th>
      <td>35332.34</td>
      <td>60.97</td>
      <td>3.601</td>
      <td>2145.50</td>
      <td>NaN</td>
      <td>33.31</td>
      <td>586.83</td>
      <td>10421.01</td>
      <td>223.015426</td>
      <td>6.170</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2012-10-19</th>
      <td>35721.09</td>
      <td>68.08</td>
      <td>3.594</td>
      <td>4461.89</td>
      <td>NaN</td>
      <td>1.14</td>
      <td>1579.67</td>
      <td>2642.29</td>
      <td>223.059808</td>
      <td>6.170</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2012-10-26</th>
      <td>34260.76</td>
      <td>69.79</td>
      <td>3.506</td>
      <td>6152.59</td>
      <td>129.77</td>
      <td>200.00</td>
      <td>272.29</td>
      <td>2924.15</td>
      <td>223.078337</td>
      <td>6.170</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
<p>143 rows × 11 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">merlion.utils</span> <span class="kn">import</span> <span class="n">TimeSeries</span>

<span class="c1"># Get the endogenous variables X and split them into train &amp; test</span>
<span class="n">endog</span> <span class="o">=</span> <span class="n">ts</span><span class="p">[[</span><span class="s2">&quot;Weekly_Sales&quot;</span><span class="p">,</span> <span class="s2">&quot;Temperature&quot;</span><span class="p">,</span> <span class="s2">&quot;CPI&quot;</span><span class="p">,</span> <span class="s2">&quot;Unemployment&quot;</span><span class="p">]]</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">TimeSeries</span><span class="o">.</span><span class="n">from_pd</span><span class="p">(</span><span class="n">endog</span><span class="p">[</span><span class="n">md</span><span class="o">.</span><span class="n">trainval</span><span class="p">])</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">TimeSeries</span><span class="o">.</span><span class="n">from_pd</span><span class="p">(</span><span class="n">endog</span><span class="p">[</span><span class="o">~</span><span class="n">md</span><span class="o">.</span><span class="n">trainval</span><span class="p">])</span>

<span class="c1"># Get the exogenous variables Y</span>
<span class="n">exog</span> <span class="o">=</span> <span class="n">TimeSeries</span><span class="o">.</span><span class="n">from_pd</span><span class="p">(</span><span class="n">ts</span><span class="p">[[</span><span class="s2">&quot;IsHoliday&quot;</span><span class="p">,</span> <span class="s2">&quot;MarkDown1&quot;</span><span class="p">,</span> <span class="s2">&quot;MarkDown2&quot;</span><span class="p">,</span> <span class="s2">&quot;MarkDown3&quot;</span><span class="p">,</span> <span class="s2">&quot;MarkDown4&quot;</span><span class="p">,</span> <span class="s2">&quot;MarkDown5&quot;</span><span class="p">]])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
The earliest univariate starts at 2010-02-05 00:00:00, but the latest univariate starts at 2011-11-11 00:00:00, a difference of 644 days 00:00:00. This is more than 10% of the length of the shortest univariate (350 days 00:00:00). You may want to check that the univariates cover the same window of time.
Stack (most recent call last):
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py&#34;, line 197, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py&#34;, line 87, in _run_code
    exec(code, run_globals)
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/ipykernel_launcher.py&#34;, line 16, in &lt;module&gt;
    app.launch_new_instance()
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/traitlets/config/application.py&#34;, line 845, in launch_instance
    app.start()
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/ipykernel/kernelapp.py&#34;, line 612, in start
    self.io_loop.start()
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/tornado/platform/asyncio.py&#34;, line 199, in start
    self.asyncio_loop.run_forever()
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py&#34;, line 596, in run_forever
    self._run_once()
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py&#34;, line 1890, in _run_once
    handle._run()
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/asyncio/events.py&#34;, line 80, in _run
    self._context.run(self._callback, *self._args)
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/tornado/ioloop.py&#34;, line 688, in &lt;lambda&gt;
    lambda f: self._run_callback(functools.partial(callback, future))
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/tornado/ioloop.py&#34;, line 741, in _run_callback
    ret = callback()
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/tornado/gen.py&#34;, line 814, in inner
    self.ctx_run(self.run)
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/tornado/gen.py&#34;, line 775, in run
    yielded = self.gen.send(value)
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/ipykernel/kernelbase.py&#34;, line 374, in dispatch_queue
    yield self.process_one()
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/tornado/gen.py&#34;, line 250, in wrapper
    runner = Runner(ctx_run, result, future, yielded)
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/tornado/gen.py&#34;, line 741, in __init__
    self.ctx_run(self.run)
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/tornado/gen.py&#34;, line 775, in run
    yielded = self.gen.send(value)
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/ipykernel/kernelbase.py&#34;, line 358, in process_one
    yield gen.maybe_future(dispatch(*args))
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/tornado/gen.py&#34;, line 234, in wrapper
    yielded = ctx_run(next, result)
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/ipykernel/kernelbase.py&#34;, line 261, in dispatch_shell
    yield gen.maybe_future(handler(stream, idents, msg))
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/tornado/gen.py&#34;, line 234, in wrapper
    yielded = ctx_run(next, result)
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/ipykernel/kernelbase.py&#34;, line 536, in execute_request
    self.do_execute(
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/tornado/gen.py&#34;, line 234, in wrapper
    yielded = ctx_run(next, result)
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/ipykernel/ipkernel.py&#34;, line 302, in do_execute
    res = shell.run_cell(code, store_history=store_history, silent=silent)
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/ipykernel/zmqshell.py&#34;, line 539, in run_cell
    return super(ZMQInteractiveShell, self).run_cell(*args, **kwargs)
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/IPython/core/interactiveshell.py&#34;, line 2898, in run_cell
    result = self._run_cell(
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/IPython/core/interactiveshell.py&#34;, line 2944, in _run_cell
    return runner(coro)
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/IPython/core/async_helpers.py&#34;, line 68, in _pseudo_sync_runner
    coro.send(None)
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/IPython/core/interactiveshell.py&#34;, line 3169, in run_cell_async
    has_raised = await self.run_ast_nodes(code_ast.body, cell_name,
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/IPython/core/interactiveshell.py&#34;, line 3361, in run_ast_nodes
    if (await self.run_code(code, result,  async_=asy)):
  File &#34;/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/IPython/core/interactiveshell.py&#34;, line 3441, in run_code
    exec(code_obj, self.user_global_ns, self.user_ns)
  File &#34;&lt;ipython-input-2-f4b6cbd5939f&gt;&#34;, line 9, in &lt;module&gt;
    exog = TimeSeries.from_pd(ts[[&#34;IsHoliday&#34;, &#34;MarkDown1&#34;, &#34;MarkDown2&#34;, &#34;MarkDown3&#34;, &#34;MarkDown4&#34;, &#34;MarkDown5&#34;]])
  File &#34;/Users/abhatnagar/Desktop/Merlion/merlion/utils/time_series.py&#34;, line 794, in from_pd
    return cls(df=df, freq=freq, check_aligned=check_aligned)
  File &#34;/Users/abhatnagar/Desktop/Merlion/merlion/utils/time_series.py&#34;, line 493, in __init__
    logger.warning(
</pre></div></div>
</div>
<p>Here, our task is to predict the weekly sales. We would like our model to also account for variables which may have an impact on consumer demand (i.e. temperature, consumer price index, and unemployment), as knowledge of these variables could improve the quality of our sales forecast. This would be a multivariate forecasting problem, covered <a class="reference internal" href="2_ForecastMultivariate.html"><span class="doc">here</span></a>.</p>
<p>In principle, we could add markdowns and holidays to the multivariate model. However, as a retailer, we know a priori which days are holidays, and we ourselves control the markdowns. In many cases, we can get better forecasts by providing the future values of these variables in addition to the past values. Moreover, we may wish to model how changing the future markdowns would change the future sales. This is why we should model these variables as exogenous regressors instead.</p>
<p>All Merlion forecasters support an API which accepts exogenous regressors at both training and inference time, though only some models actually support the feature. Using the feature is as easy as specifying an optional argument <code class="docutils literal notranslate"><span class="pre">exog_data</span></code> to both <code class="docutils literal notranslate"><span class="pre">train()</span></code> and <code class="docutils literal notranslate"><span class="pre">forecast()</span></code>. We show how to use the feature for the popular <code class="docutils literal notranslate"><span class="pre">Prophet</span></code> model below, and demonstrate that adding exogenous regressors can improve the quality of the forecast.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">merlion.evaluate.forecast</span> <span class="kn">import</span> <span class="n">ForecastMetric</span>
<span class="kn">from</span> <span class="nn">merlion.models.forecast.prophet</span> <span class="kn">import</span> <span class="n">Prophet</span><span class="p">,</span> <span class="n">ProphetConfig</span>

<span class="c1"># Train a model without exogenous data</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Prophet</span><span class="p">(</span><span class="n">ProphetConfig</span><span class="p">(</span><span class="n">target_seq_index</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="n">pred</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">time_stamps</span><span class="p">)</span>
<span class="n">smape</span> <span class="o">=</span> <span class="n">ForecastMetric</span><span class="o">.</span><span class="n">sMAPE</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">target_seq_index</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">target_seq_index</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sMAPE (w/o exog) = </span><span class="si">{</span><span class="n">smape</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Train a model with exogenous data</span>
<span class="n">exog_model</span> <span class="o">=</span> <span class="n">Prophet</span><span class="p">(</span><span class="n">ProphetConfig</span><span class="p">(</span><span class="n">target_seq_index</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="n">exog_model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">exog_data</span><span class="o">=</span><span class="n">exog</span><span class="p">)</span>
<span class="n">exog_pred</span><span class="p">,</span> <span class="n">exog_err</span> <span class="o">=</span> <span class="n">exog_model</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">time_stamps</span><span class="p">,</span> <span class="n">exog_data</span><span class="o">=</span><span class="n">exog</span><span class="p">)</span>
<span class="n">exog_smape</span> <span class="o">=</span> <span class="n">ForecastMetric</span><span class="o">.</span><span class="n">sMAPE</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">exog_pred</span><span class="p">,</span> <span class="n">target_seq_index</span><span class="o">=</span><span class="n">exog_model</span><span class="o">.</span><span class="n">target_seq_index</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sMAPE (w/ exog)  = </span><span class="si">{</span><span class="n">exog_smape</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
17:50:59 - cmdstanpy - INFO - Chain [1] start processing
17:50:59 - cmdstanpy - INFO - Chain [1] done processing
17:50:59 - cmdstanpy - INFO - Chain [1] start processing
17:50:59 - cmdstanpy - INFO - Chain [1] done processing
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
sMAPE (w/o exog) = 3.98
sMAPE (w/ exog)  = 3.18
</pre></div></div>
</div>
<p>Before we wrap up this tutorial, we note that the exogenous variables contain a lot of missing data:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">exog</span><span class="o">.</span><span class="n">to_pd</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>IsHoliday</th>
      <th>MarkDown1</th>
      <th>MarkDown2</th>
      <th>MarkDown3</th>
      <th>MarkDown4</th>
      <th>MarkDown5</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2010-02-05</th>
      <td>False</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2010-02-12</th>
      <td>True</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2010-02-19</th>
      <td>False</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2010-02-26</th>
      <td>False</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2010-03-05</th>
      <td>False</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2012-09-28</th>
      <td>False</td>
      <td>7106.05</td>
      <td>1.91</td>
      <td>1.65</td>
      <td>1549.10</td>
      <td>3946.03</td>
    </tr>
    <tr>
      <th>2012-10-05</th>
      <td>False</td>
      <td>6037.76</td>
      <td>NaN</td>
      <td>10.04</td>
      <td>3027.37</td>
      <td>3853.40</td>
    </tr>
    <tr>
      <th>2012-10-12</th>
      <td>False</td>
      <td>2145.50</td>
      <td>NaN</td>
      <td>33.31</td>
      <td>586.83</td>
      <td>10421.01</td>
    </tr>
    <tr>
      <th>2012-10-19</th>
      <td>False</td>
      <td>4461.89</td>
      <td>NaN</td>
      <td>1.14</td>
      <td>1579.67</td>
      <td>2642.29</td>
    </tr>
    <tr>
      <th>2012-10-26</th>
      <td>False</td>
      <td>6152.59</td>
      <td>129.77</td>
      <td>200.00</td>
      <td>272.29</td>
      <td>2924.15</td>
    </tr>
  </tbody>
</table>
<p>143 rows × 6 columns</p>
</div></div>
</div>
<p>Behind the scenes, Merlion models will apply an optional <code class="docutils literal notranslate"><span class="pre">exog_transform</span></code> to the exogenous variables, and they will then resample the exogenous variables to the same timestamps as the endogenous variables. This resampling is achieved using the <code class="docutils literal notranslate"><span class="pre">exog_missing_value_policy</span></code> and <code class="docutils literal notranslate"><span class="pre">exog_aggregation_policy</span></code>, which can be specified in the config of any model which accepts exogenous regressors. We can see the default values for each of these parameters by inspecting the config:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Default exog_transform:            </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">exog_model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">exog_transform</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Default exog_missing_value_policy: </span><span class="si">{</span><span class="n">exog_model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">exog_missing_value_policy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Default exog_aggregation_policy:   </span><span class="si">{</span><span class="n">exog_model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">exog_aggregation_policy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Default exog_transform:            MeanVarNormalize
Default exog_missing_value_policy: MissingValuePolicy.ZFill
Default exog_aggregation_policy:   AggregationPolicy.Mean
</pre></div></div>
</div>
<p>So in this case, we first apply mean-variance normalization to the exogenous data. Then, we impute missing values by filling them with zeros (<code class="docutils literal notranslate"><span class="pre">ZFill</span></code>), and we downsample the exogenous data by taking the <code class="docutils literal notranslate"><span class="pre">Mean</span></code> of any relevant windows.</p>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="2_ForecastMultivariate.html" class="btn btn-neutral float-left" title="Multivariate Time Series Forecasting" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="4_ForecastNewModel.html" class="btn btn-neutral float-right" title="Adding a New Forecasting Model" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, salesforce.com, inc..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Versions</span>
      latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      <dl>
        <dt>Versions</dt>
        
           <strong> 
          
          <dd><a href="../../../latest/index.html">latest</a></dd>
           </strong> 
        
          
          
          <dd><a href="../../../v2.0.2/index.html">v2.0.2</a></dd>
          
        
          
          
          <dd><a href="../../../v2.0.1/index.html">v2.0.1</a></dd>
          
        
          
          
          <dd><a href="../../../v2.0.0/index.html">v2.0.0</a></dd>
          
        
          
          
          <dd><a href="../../../v1.3.1/index.html">v1.3.1</a></dd>
          
        
          
          
          <dd><a href="../../../v1.3.0/index.html">v1.3.0</a></dd>
          
        
          
          
          <dd><a href="../../../v1.2.5/index.html">v1.2.5</a></dd>
          
        
          
          
          <dd><a href="../../../v1.2.4/index.html">v1.2.4</a></dd>
          
        
          
          
          <dd><a href="../../../v1.2.3/index.html">v1.2.3</a></dd>
          
        
          
          
          <dd><a href="../../../v1.2.2/index.html">v1.2.2</a></dd>
          
        
          
          
          <dd><a href="../../../v1.2.1/index.html">v1.2.1</a></dd>
          
        
          
          
          <dd><a href="../../../v1.2.0/index.html">v1.2.0</a></dd>
          
        
          
          
          <dd><a href="../../../v1.1.3/index.html">v1.1.3</a></dd>
          
        
          
          
          <dd><a href="../../../v1.1.2/index.html">v1.1.2</a></dd>
          
        
          
          
          <dd><a href="../../../v1.1.1/index.html">v1.1.1</a></dd>
          
        
          
          
          <dd><a href="../../../v1.1.0/index.html">v1.1.0</a></dd>
          
        
          
          
          <dd><a href="../../../v1.0.2/index.html">v1.0.2</a></dd>
          
        
          
          
          <dd><a href="../../../v1.0.1/index.html">v1.0.1</a></dd>
          
        
          
          
          <dd><a href="../../../v1.0.0/index.html">v1.0.0</a></dd>
          
        
      </dl>
      
    </div>
  </div>

 <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>